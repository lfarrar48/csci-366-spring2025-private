var maxHeight,maxWidth,lmcScale,lessExamples=!0;function startIt(){getDimensions(),main()}function getDimensions(){if("number"==typeof window.innerWidth?(maxWidth=window.innerWidth,maxHeight=window.innerHeight):(maxWidth=document.documentElement.clientWidth,maxHeight=document.documentElement.clientHeight),lmcScale=1,maxWidth>901&&maxHeight>556){var e=maxHeight/556;e<(lmcScale=maxWidth/901)&&(lmcScale=e)}var t=document.getElementById("lmcBody");t.style.transform="scale("+lmcScale+","+lmcScale+")",t.style.overflow=1==lmcScale?"":"hidden"}function rectangle(e,t,n,o,r,a,u){t=Math.floor(t+.49),n=Math.floor(n+.49),(t<0||n<0||o<=0||r<=0||o>maxWidth-10||r>maxHeight-10)&&console.log("rectangle - warning - not on screen");var s=document.getElementById(e);if(s){if("DIV"!=s.nodeName)return void console.log("rectangle - name already in use for non-rectangle/text")}else(s=document.createElement("div")).id=e,document.body.appendChild(s);s.style.position="absolute",s.style.left=t+"px",s.style.top=n+"px",s.style.width=o+"px",s.style.height=r+"px",s.style.background=a,u&&(s.style.border="medium solid "+u)}function text(e,t,n,o,r,a,u,s,i){n=Math.floor(n+.49),o=Math.floor(o+.49),(n<0||o<0||n>maxWidth-10||o>maxHeight-10)&&console.log("text - warning - not on screen");var l=document.getElementById(e);if(l){if("DIV"!=l.nodeName)return void console.log("text - name already in use for non-rectangle/text")}else(l=document.createElement("div")).id=e,document.body.appendChild(l);l.style.position="absolute",l.style.left=n+"px",l.style.top=o+"px",l.style.color=a,l.style.fontSize=r+"px",i&&(l.style.fontFamily=i),u&&l.setAttribute(u,s),l.innerHTML=t}function move(e,t,n){t=Math.floor(t+.49),n=Math.floor(n+.49),(t<0||n<0||t>maxWidth-10||n>maxHeight-10)&&console.log("move - warning - not on screen");var o=document.getElementById(e);o?(o.style.position="absolute",o.style.left=t+"px",o.style.top=n+"px"):console.log("move- name "+e+" does not exist")}function remove(e){var t=document.getElementById(e);t&&document.body.removeChild(t)}function randomInt(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function button(e,t,n,o,r){n=Math.floor(n+.49),o=Math.floor(o+.49),(n<0||o<0||n>maxWidth-10||o>maxHeight-10)&&console.log("button - warning - not on screen");var a=document.getElementById(e);if(a){if("FORM"!=a.nodeName)return void console.log("button - name already in use for non-button")}else(a=document.createElement("form")).id=e,document.body.appendChild(a);a.style.position="absolute",a.style.left=n+"px",a.style.top=o+"px",a.innerHTML='<input type="button" value="'+t+'" onClick="'+r+'">'}function image(e,t,n,o,r){n=Math.floor(n+.49),o=Math.floor(o+.49),(n<0||o<0||n>maxWidth-10||o>maxHeight-10)&&console.log("image - warning - not on screen");var a=document.getElementById(e);if(a){if("IMG"!=a.nodeName)return void console.log("image- name already in use for non-image")}else(a=document.createElement("img")).id=e,document.body.appendChild(a);a.style.position="absolute",a.style.left=n+"px",a.style.top=o+"px",a.src=t,a.alt=r}function imageOrder(e,t){var n=document.getElementById(e);n?n.style.zIndex=t:console.log("imageOrder - name "+e+" does not exist")}function getMilliseconds(){return(new Date).getTime()}function delay(e,t){for(var n=t+"(",o=2;o<arguments.length;o++)o>2&&(n+=","),n+=arguments[o];return n+=")",setTimeout(n,e)}var chrsToMatch=[],dnFnCall=[],upFnCall=[],chrsDown=[];function trapKey(e,t,n){var o=chrsToMatch.indexOf(e);-1==o&&(o=chrsToMatch.push(e)-1,chrsDown[o]=0),dnFnCall[o]=t,upFnCall[o]=n}function keyDown(e){var t=e.keyCode;if(8==t){var n,o=e.srcElement||e.target;switch(o.tagName.toUpperCase()){case"TEXTAREA":n=o.readOnly||o.disabled;break;case"INPUT":n=o.readOnly||o.disabled||o.attributes.type&&$.inArray(o.attributes.type.value.toLowerCase(),["radio","checkbox","submit","button"])>=0;break;case"DIV":n=o.readOnly||o.disabled||!(o.attributes.contentEditable&&"true"==o.attributes.contentEditable.value);break;default:n=!0;break}n&&e.preventDefault()}var r=String.fromCharCode(t);27!=t&&9!=t||(r=t);var a=chrsToMatch.indexOf(r);-1==a||(chrsDown[a]=1,dnFnCall[a]&&window[dnFnCall[a]](e))}function keyUp(e){var t=e.keyCode,n=String.fromCharCode(t);27!=t&&9!=t||(n=t);var o=chrsToMatch.indexOf(n);-1!=o&&1==chrsDown[o]&&(chrsDown[o]=0,upFnCall[o]&&window[upFnCall[o]](e))}var speed,inst,addr,stopping,runRate,oneStep,submit,holdI,myTimeout=!1,myTimeout1=!1,myTimeout2=!1,accumulator=0,pCounter=0,programText="",programHTML="",programEdit="",codeText="",output1="",output2="",outputCount=0,outputCount2=0,address=[],instructionTxt=[],defaultSpeed=175,waitingForInput=!1,modifyingProgram=!1,savOpenAddress=!1,s2T=1,valW=5,assembleOption=4,monospace='"Courier New Bold",courier,monospace',running=!1;function main(){window.document.title="Little Man Computer - CPU simulator",trapKey(9,"tabKey",null),trapKey(27,"escKey",null),rectangle("background",0,0,885,540,"LightBlue","LightBlue"),image("layout","lmcgraphic_plh.gif",0,0,"LMC layout"),image("pcMarker","pcMarker.png",479,46,"PC marker"),rectangle("program",9,42,172,432,"white",""),rectangle("code",193,42,94,432,"white",""),rectangle("output1",307,27,30,117,"white",""),rectangle("output2",341,27,30,117,"white",""),rectangle("input",309,488,58,20,"white","white"),rectangle("pc",310,206,20,20,"white","white"),rectangle("ir",320,248,10,20,"white","white"),rectangle("ar",376,280,20,20,"white","white"),rectangle("acc",340,337,38,20,"white","white"),rectangle("message",485,480,381,19,"white","white"),button("assemble","ASSEMBLE INTO RAM",3,482,"assemble()"),button("reset","RESET",3,505,"reset1()"),window.File&&window.FileReader?text("load",loadText,75,505,12,"black"):alert("The File APIs are not supported in this browser."),button("help","HELP",137,505,"window.open('help_new.html')"),text("ch",menu,201,506,12,"black"),text("op",options,470,513,12,"black"),programText="",programHTML="",programEdit="",address=[],defaultSpeed=175,modifyingProgram=!1,savOpenAddress=!1,s2T=1,valW=5,assembleOption=4,text("program","",9,42,10,"black","onclick","openProgram(this)",monospace),message("SELECT or enter a program, LOAD a file or alter memory"),text("ver","V1.5b",568,8,12,"black"),delay(1,"main1")}function main1(){holdI=0,runRate=getMilliseconds(),main2()}function main2(){for(var e=0;e<5;++e)rectangle("a"+holdI,472+holdI%10*37,60+42*Math.floor(holdI/10),28,16,"white","gray"),setAddress(holdI,0),++holdI;holdI>=100?(reset1(),delay(1,"main3")):delay(1,"main2")}function main3(){runRate=(getMilliseconds()-runRate)/20,console.log("runRate for updates is "+runRate);var e=document.cookie.indexOf("RATELIMIT=");if(e>=0&&document.cookie.length>e+33){let t=document.cookie.substr(e+10,21),n=new Date,o=n.getTime(),r=(lessExamples?"lmc":"LMC")+Math.floor(o/36e5);n.setTime(o+2591e3);const a="expires="+n.toUTCString();-1==t.indexOf(";")&&(document.cookie="RATELIMIT="+t+r+"; "+a+"; path=/")}plh_restart=!0}function escKey(e){if(waitingForInput&&!(myTimeout||myTimeout1||myTimeout2)){if(e.preventDefault(),waitingForInput=!1,savOpenAddress){var t=parseInt(savOpenAddress.id[1]);3==savOpenAddress.id.length&&(t=10*t+parseInt(savOpenAddress.id[2])),setAddress(t,address[t]),savOpenAddress=!1}else modifyingProgram?(modifyingProgram=!1,textToHtml()):(updatePC(pCounter),updatePCmarker(pCounter));message("ESC pressed to abort input")}}function tabKey(e){if(e.preventDefault(),waitingForInput&&!(myTimeout||myTimeout1||myTimeout2))if(savOpenAddress){var t=parseInt(savOpenAddress.id[1]);3==savOpenAddress.id.length&&(t=10*t+parseInt(savOpenAddress.id[2]));var n=!0,o=document.getElementById("aForm");if(isNaN(o.value)&&(n=!1),loseAddress(o),t<99){++t,n&&message("Modifying memory contents");var r=document.getElementById("a"+t);r.innerHTML='<form action="javascript:addressSubmit()"><input id="aForm" type="text" style="padding:0; border:0; width:60px;"></form>',document.getElementById("aForm").focus(),document.getElementById("aForm").setAttribute("onblur","loseAddress(this)"),waitingForInput=!0,savOpenAddress=r}}else if(modifyingProgram){var a=document.getElementById("pForm"),u=a.selectionStart;a.value=a.value.substring(0,a.selectionStart)+"\t"+a.value.substring(a.selectionEnd),a.selectionEnd=u+1}else{losePC(o=document.getElementById("PCForm"))}}function openProgram(e){waitingForInput||myTimeout||myTimeout1||myTimeout2||(submit=!0,message("Modifying Program Area"),e.style.overflow="initial",e.innerHTML='<form action="javascript:programSubmit()"><textarea id="pForm" rows="32" cols="25" style="padding:0; border:0; font-size:10px;" spellcheck="false">'+programEdit+'</textarea><input type="submit" value="Submit" style="color:red;font-weight:bold;margin:5px"><input onclick="programCancel()" type="submit" value="Cancel" style="color:red;font-weight:bold;margin:5px"></form>',document.getElementById("pForm").focus(),waitingForInput=!0,modifyingProgram=!0)}function programSubmit(){if(!waitingForInput)return alert("Bad input - not waiting for input"),!1;var e=document.getElementById("pForm");waitingForInput=!1,modifyingProgram=!1,submit?(programText=e.value,textToHtml(),assemble()):(text("program",programHTML,9,42,3==assembleOption?9:10,"black","onclick","openProgram(this)",monospace),document.getElementById("program").style.overflow="auto")}function programCancel(){submit=!1}function ch2(){reset1();var e=document.getElementById("ch1").value;e>0&&e<(lessExamples?5:11)?(programText=program[e],textToHtml(),assemble()):message("Bad selection")}function op2(){var e=document.getElementById("op1").value;if(1==e){for(var t=0;t<100;++t)setAddress(t,0);text("op",options,470,513,12,"black")}else e>1&&e<5?(reset1(),text("program",programHTML,9,42,3==(assembleOption=e)?9:10,"black","onclick","openProgram(this)",monospace),assemble()):e>4&&e<8&&(defaultSpeed=175,5==e&&(defaultSpeed=1),7==e&&(defaultSpeed=250),running&&(speed=defaultSpeed,doSpeed()))}function read_chg(e){reset1();var t=e.files;if(t){var n=new FileReader;n.readAsText(t[0],"utf-8"),n.onload=function(){programText=n.result,textToHtml(),assemble(),text("ch",menu,201,506,12,"black"),text("load",loadText,75,505,12,"black")}}else alert("BAD FILE SELECTION RETURN")}instructionTxt[0]="Program HALTED, RESET, LOAD, SELECT or alter memory",instructionTxt[1]="ADD to accumulator the contents of RAM address ",instructionTxt[2]="SUBTRACT from accumulator the contents of RAM address ",instructionTxt[3]="STORE value in accumulator at RAM address ",instructionTxt[4]="Bad instruction ",instructionTxt[5]="LOAD into accumulator the contents of RAM address ",instructionTxt[6]="BRANCH to memory address ",instructionTxt[7]="BRANCH (if zero) to memory address ",instructionTxt[8]="BRANCH (if zero or positive) to memory address ",instructionTxt[9]="INPUT a value into accumulator",instructionTxt[10]="OUTPUT value stored in accumulator",instructionTxt[11]="OUTPUT accumulator contents as a character";var program=[];if(program[1]="\tINP\n\tSTA 99\n\tINP\n\tADD 99\n\tOUT\n\tHLT\n// Output the sum of two numbers\n",program[2]="\tINP\n\tSTA FIRST\n\tINP\n\tADD FIRST\n\tOUT\n\tINP\n\tSUB FIRST\n\tOUT\n\tHLT\nFIRST\tDAT\n// Input three numbers.\n// Output the sum of the first two\n// and the third minus the first\n",lessExamples?(program[3]="lda space\nsta char\nloop lda char\notc\nadd one\nsta char\nsub max\nbrz end\nbra loop\nend hlt\nspace dat 32\none dat 1\nmax dat 127\nchar dat\n// output the basic ASCII characters\n",program[4]="lda space\nsta char\nloop lda char\nout\nlda space\notc\nlda char\notc\nadd one\nsta char\nsub max\nbrz end\nbra loop\nend hlt\nspace dat 32\none dat 1\nmax dat 97\nchar dat\n// start of ASCII character table\n"):(program[3]="\tINP\n\tSTA FIRST\n\tINP\n\tSTA SECOND\n\tSUB FIRST\n\tBRP HIGHER\n\tLDA FIRST\n\tBRA DONE\nHIGHER\tLDA SECOND\nDONE\tOUT\n\tHLT\nFIRST\tDAT\nSECOND\tDAT\n// Input two numbers and output the higher\n\t",program[4]="\tINP\n\tSTA VALUE\n\tLDA ZERO\n\tSTA TRINUM\n\tSTA N\nLOOP\tLDA TRINUM\n\tSUB VALUE\n\tBRP ENDLOOP\n\tLDA N\n\tADD ONE\n\tSTA N\n\tADD TRINUM\n\tSTA TRINUM\n\tBRA LOOP\nENDLOOP\tLDA VALUE\n\tSUB TRINUM\n\tBRZ EQUAL\n\tLDA ZERO\n\tOUT\n\tBRA DONE\nEQUAL\tLDA N\n\tOUT\nDONE\tHLT\nVALUE\tDAT\nTRINUM\tDAT\nN\tDAT\nZERO\tDAT 000\nONE\tDAT 001\n// Test if input is a triangular number\n// If is sum of 1 to n output n\n// otherwise output zero\n",program[5]="\tINP\n\tSTA VALUE\n\tLDA ZERO\n\tSTA SUM\n\tSTA COUNT\nLOOP\tLDA SUM\n\tADD VALUE\n\tSTA SUM\n\tLDA COUNT\n\tADD ONE\n\tSTA COUNT\n\tSUB VALUE\n\tBRP DONE\n\tBRA LOOP\nDONE\tLDA SUM\n\tOUT\n\tHLT\nVALUE\tDAT\n\tSUM DAT\nCOUNT\tDAT\nZERO\tDAT 000\nONE\tDAT 001\n// Output the square of a number input\n",program[6]="INP\nSTA VALUE\nLDA ZERO\nSTA SUM\nLDA ONE\nSTA MULT\nBRA LOOP\n.LOC    50\nLOOP    LDA SUM\nADD VALUE\nSTA SUM\nOUT\nLDA MULT\nADD ONE\nSTA MULT\nSUB VALUE\nBRZ LOOP\nBRP DONE\nBRA LOOP\nDONE    HLT\nBRA 0\nVALUE   DAT 0\nMULT    DAT 0\nSUM     DAT\nZERO    DAT 000\nONE     DAT 001\n// Times table for\n// one input number\n// with example of .LOC\n",program[7]="LDA lda1\nSTA outputList\nLDA sta1\nSTA store\nLDA zero\nSTA listSize\ninputLoop INP\nBRZ resetLoop\nstore DAT 380\nLDA store\nADD increment\nSTA store\nLDA listSize\nADD increment\nSTA listSize\nBRA inputLoop\nresetLoop LDA lda1\nSTA load1\nADD increment\nSTA load2\nLDA sta1\nSTA store1\nADD increment\nSTA store2\nLDA listSize\nSUB increment\nSTA loopCount\nLDA zero\nSTA isChange\nload1 DAT 580\nSTA buffA\nload2 DAT 581\nSTA buffB\ncmp SUB buffA\nBRP nextItem\nswap LDA buffB\nstore1 DAT 380\nLDA buffA\nstore2 DAT 381\nLDA increment\nSTA isChange\nnextItem LDA store1\nADD increment\nSTA store1\nADD increment\nSTA store2\nLDA load1\nADD increment\nSTA load1\nADD increment\nSTA load2\nLDA loopCount\nSUB increment\nSTA loopCount\nBRZ isFinished\nBRA load1\nisFinished LDA isChange\nBRZ outputList\nbra resetLoop\noutputList DAT 580\nOUT\nLDA outputList\nADD increment\nSTA outputList\nLDA listSize\nSUB increment\nSTA listSize\nBRZ end\nBRA outputList\nend HLT\nzero DAT 0\nbuffA DAT 0\nbuffB DAT 0\nisChange DAT 0\nincrement DAT 1\nlistSize DAT 0\nloopCount DAT 0\nsta1 DAT 380\nlda1 DAT 580\n",program[8]="BRA writeLoop\ns1 DAT\ns2 DAT\ns3 DAT\ns4 DAT\ns5 DAT\ns6 DAT\ns7 DAT\ns8 DAT\ns9 DAT\nwriteLoop INP\nBRZ readLoop\nwriteStart DAT 300\nLDA writeStart \nADD one\nSTA writeStart\nLDA count\nADD one\nSTA count\nBRA writeLoop \nreadLoop LDA count\nSUB one\nSTA count\nBRZ done\nreadStart DAT 500\nOUT\nLDA readStart\nADD one\nSTA readStart\nBRA readLoop \ndone HLT\ncount DAT 1\none DAT 1\n",program[9]="lda space\nsta char\nloop lda char\notc\nadd one\nsta char\nsub max\nbrz end\nbra loop\nend hlt\nspace dat 32\none dat 1\nmax dat 127\nchar dat\n// output the basic ASCII characters\n",program[10]="lda space\nsta char\nloop lda char\nout\nlda space\notc\nlda char\notc\nadd one\nsta char\nsub max\nbrz end\nbra loop\nend hlt\nspace dat 32\none dat 1\nmax dat 97\nchar dat\n// start of ASCII character table\n"),lessExamples)var menu='<select id="ch1" onchange="ch2()"><option value="0">SELECT</option><option value="1">add</option><option value="2">add/subtr</option><option value="3">ascii</option><option value="4">ascii table</option></select>';else menu='<select id="ch1" onchange="ch2()"><option value="0">SELECT</option><option value="1">add</option><option value="2">add/subtr</option><option value="3">max</option><option value="4">is sum 1-n</option><option value="5">square</option><option value="6">times table</option><option value="7">bubble sort</option><option value="8">overwrite</option><option value="9">ascii</option><option value="10">ascii table</option></select>';var loadText='<input type="file" id="read-input" onchange="read_chg(this)" autocomplete="off" style="display:none;" ><button onclick="document.getElementById(&#39;read-input&#39;).click()">LOAD</button>',inputForm='<form action="javascript:inputSubmit()"><input id="iForm" type="text" style="padding:0; border:0; width:60px; font-size:16px;"></form>',options='<select id="op1" onchange="op2()"><option value="0">OPTIONS</option><option value="1">clear memory</option><option value="2">show op codes</option><option value="3">show decimal</option><option value="4">hide op codes</option><option value="5">default fast</option><option value="6">default normal</option><option value="7">default slow</option></select>';function textToHtml(){programHTML="",programEdit="";var e=0,t=programText.length;"\n"!=programText[t-1]&&(programText+="\n",++t);for(var n=0;n<t;++n){var o=programText[n];if("\t"==o&&(o=" "),!(" "==o&&n+1<t&&" "==programText[n+1]||"\n"!=o&&o<" ")){if(0==e){if("\n"==o)continue;if(" "==o)continue;"/"==o&&(e=10),n+3<t&&instruction((o+programText[n+1]+programText[n+2]).toUpperCase())<100&&programText[n+3]<=" "&&(programHTML+="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",programEdit+="        ",e=7)}for(;e<7&&" "==o&&programText[n+1]>" ";)programEdit+=" ",programHTML+="&nbsp;",++e;"\n"==o?(n+1<t&&(programHTML+="<br />"),programEdit+="\n",e=0):(++e,programHTML+=o,programEdit+=o)}}text("program",programHTML,9,42,3==assembleOption?9:10,"black","onclick","openProgram(this)",monospace),document.getElementById("program").style.overflow="auto"}function make_error(e,t){return e==t?" at line "+e:" line "+e+"  address "+t}function message(e){text("message",e,485,480,14,"#FF0000")}function assemble(){if(!waitingForInput){reset1();for(var e=0;e<100;++e)setAddress(e,0);var t=programText.length;"\n"!=programText[t-1]&&(programText+="\n",++t);for(var n=0,o=0,r="",a=[],u=[],s=[],i=0;i<t;++i){var l=programText[i];if("\t"==l&&(l=" "),(" "==l||"\n"==l)&&""!=r){if(0==o&&instruction(r.toUpperCase())<100&&(a[n]=0,++o),0==o){if(".LOC"!=r.toUpperCase()){var d;for(d=0;d<n&&r!=a[d];++d);if(d<n)return void message("duplicate label at lines "+d+" and "+n+" &nbsp;"+r)}a[n]=r}else 1==o?u[n]=r.toUpperCase():2==o&&(s[n]=r);r="",++o}"\n"==l&&o>0&&(1==o&&(u[n]=0),o<3&&(s[n]=0),"//"!=a[n]&&++n,o=0),l>" "&&(r+=l)}var m=0,p=0,c=!1;for(codeText="";m<n;){var b=instruction(u[m]);if(100==b){if(0==a[m]||".LOC"!=a[m].toUpperCase()||isNaN(u[m])){c="unknown instruction"+make_error(m,p)+" "+u[m];break}if(p>u[m]||u[m]>99){c="bad .LOC"+make_error(m,p)+" "+u[m];break}p=u[m]}else{p<10&&(codeText+="0"),codeText+=p+" ";var T,f=0,g=instructions[b];if(b>0&&b<10){if(isNaN(s[m])){var v=0;for(e=0;e<n;++e)if(0==a[e]||".LOC"!=a[e].toUpperCase()||isNaN(u[e])){if(s[m]==a[e])break;"//"!=a[e]&&++v}else v=Number(u[e]);if(!(e<n)){c="unknown address label"+make_error(m,p)+" "+s[m];break}f=v}else f=+s[m];2!=assembleOption&&(g+=" ",g+=f>=0&&f<10?"0"+f:f)}if(T=+(T=9==b?0:10==b?901:11==b?902:12==b?922:100*b)+ +f,3==assembleOption&&(T>=0?(T<10?codeText+="00":T<100&&(codeText+="0"),codeText+=T+" "):codeText+=T>-10?"-0"+-T+" ":T+" "),codeText+=g,2==assembleOption&&(codeText+=T<0||9==b?" "+T:T<10?" 0 0"+T:T<100?" 0 "+b:T%100<10?" "+Math.floor(T/100)+" 0"+T%100:" "+Math.floor(T/100)+" "+T%100),codeText+="<br />",p>99){c="memory exceeded"+make_error(m,p);break}setAddress(p,T),++p}++m}if(c){message(c);for(e=0;e<100;++e)setAddress(e,0);codeText+=c+"<br />"}else message("RUN/STEP your program, SELECT, LOAD or edit program");text("code",codeText,193,42,3==assembleOption?9:10,"black","","",monospace),document.getElementById("code").style.overflow="auto"}}function updatePC(e){e>=100&&(e=0),pCounter=e,e<10&&(e="0"+e),text("pc",e,310,206,20,"black","onclick","openPC(this)")}function openPC(e){waitingForInput||myTimeout||myTimeout1||myTimeout2||(message("Modifying Program Counter contents"),e.innerHTML='<form action="javascript:PCSubmit()"><input id="PCForm" type="text" style="padding:0; border:0; width:20px;"></form>',document.getElementById("PCForm").focus(),document.getElementById("PCForm").setAttribute("onblur","losePC(this)"),waitingForInput=!0)}function PCSubmit(){if(waitingForInput){var e=document.getElementById("PCForm");if(e.removeAttribute("onblur"),isNaN(e.value)||""==e.value)return alert("Bad input - must be a number"),void resetPC();var t=parseInt(e.value);if(isNaN(t)||t>99||t<0)return alert("Bad input - number out of range for PC"),void resetPC();updatePC(t),updatePCmarker(t),waitingForInput=!1,message(""==programText?"SELECT a program, LOAD a file or alter memory or program":"ASSEMBLE, RUN/STEP or alter memory or program")}else alert("Bad input - not waiting for input")}function resetPC(){document.getElementById("PCForm").removeAttribute("onblur"),updatePC(pCounter),waitingForInput=!1,message(""==programText?"SELECT a program, LOAD a file or alter memory or program":"ASSEMBLE, RUN/STEP or alter memory or program")}function losePC(e){waitingForInput&&(isNaN(e.value)||""==e.value?resetPC():PCSubmit())}function updatePCmarker(e){var t=Math.floor(e/10);move("pcMarker",479+37*(e-10*t),46+42*t)}function updateACC(e){for(;e>999;)e-=1999;for(;e<-999;)e=+e+1999;accumulator=e,e>=0?e=e<10?"&nbsp;00"+e:e<100?"&nbsp;0"+e:"&nbsp;"+e:e>-10?e="-00"+-e:e>-100&&(e="-0"+-e),text("acc",e,340,337,20,"black")}var redX,redY,blueX,blueY,blueVal,instructions=["HLT","ADD","SUB","STA","STO","LDA","BRA","BRZ","BRP","DAT","INP","OUT","OTC"];function instruction(e){for(var t=0;t<13&&e!=instructions[t];++t);return t>12?100:4==t?3:t}function openAddress(e){waitingForInput||myTimeout||myTimeout1||myTimeout2||(message("Modifying memory contents"),e.innerHTML='<form action="javascript:addressSubmit()"><input id="aForm" type="text" style="padding:0; border:0; width:60px;"></form>',document.getElementById("aForm").focus(),document.getElementById("aForm").setAttribute("onblur","loseAddress(this)"),waitingForInput=!0,savOpenAddress=e)}function addressSubmit(){if(waitingForInput){var e=document.getElementById("aForm");if(isNaN(e.value)||""==e.value)alert("Bad input - must be a number");else{var t=parseInt(e.value);if(isNaN(t)||t>999||t<-999)alert("Bad input - number out of range");else{document.getElementById("aForm").removeAttribute("onblur");var n=parseInt(savOpenAddress.id[1]);3==savOpenAddress.id.length&&(n=10*n+parseInt(savOpenAddress.id[2])),setAddress(n,t),waitingForInput=!1,savOpenAddress=!1,message(""==programText?"SELECT a program, LOAD a file or alter memory or program":"ASSEMBLE, RUN/STEP or alter memory or program")}}}else alert("Bad input - not waiting for input")}function loseAddress(e){if(waitingForInput)if(isNaN(e.value)||""==e.value){document.getElementById("aForm").removeAttribute("onblur");var t=parseInt(savOpenAddress.id[1]);3==savOpenAddress.id.length&&(t=10*t+parseInt(savOpenAddress.id[2])),setAddress(t,address[t]),waitingForInput=!1,savOpenAddress=!1,message("BAD input ignored")}else addressSubmit()}function setAddress(e,t){isNaN(t)&&alert("attempt to store NaN "+t),address[e]=t,t>=0?t=t<10?"&nbsp;00"+t:t<100?"&nbsp;0"+t:"&nbsp;"+t:t>-10?t="-00"+-t:t>-100&&(t="-0"+-t),text("a"+e,t,472+e%10*37,60+42*Math.floor(e/10),14,"black","onclick","openAddress(this)")}function step3(){oneStep=!0,run2()}function run(){oneStep=!1,run2()}function run2(){waitingForInput||(button("run","STOP",169,482,"stop()"),button("step","<<",225,482,"slower()"),button("gt",">>",255,482,"faster()"),stopping=!1,speed=defaultSpeed,doSpeed(),runContinue())}function slower(){speed>225||(speed>=50?speed+=25:speed>=5?speed+=5:++speed,doSpeed())}function doSpeed(){running=!0;var e=(250-speed)/25;s2T=3,valW=1,speed<=100?text("speed","SPEED "+e,213,529,12,"blue"):(text("speed","SHOW FETCH/EXECUTE &nbsp; SPEED "+e,70,529,12,"blue"),e<5&&(valW=runRate<4.5?5:4),4==e&&(s2T=2),e<=3&&(s2T=1),2==e&&(valW*=2),1==e&&(valW*=4),0==e&&(valW*=8))}function faster(){speed<=100&&step2Busy||(speed>=75?speed-=25:speed>=10?speed-=5:speed>1&&--speed,doSpeed())}function runContinuex(){step2Busy?myTimeout=delay(speed,"runContinuex"):speed<125||stopping?runContinue():myTimeout=delay((speed+200)/s2T,"runContinue")}function runContinuey(){step2Busy?myTimeout=delay(25,"runContinuey"):(button("run","RUN",174,482,"run()"),button("step","STEP",235,482,"step3()"),remove("gt"),remove("speed"),running=!1,myTimeout=!1)}function runContinuez(){myTimeout=delay(speed,waitingForInput?"runContinuez":"runContinue")}function runContinue(){if(myTimeout=!1,stopping)return button("run","RUN",174,482,"run()"),button("step","STEP",235,482,"step3()"),remove("gt"),remove("speed"),running=!1,void(oneStep||message("Program stopped. RUN or STEP to continue, RESET to abort."));if(oneStep&&(stopping=!0),speed>100){var e=address[pCounter];return step2(),e<100||e>=400&&e<500||900==e||e>902&&e<922||e>922?void(myTimeout=delay(25,"runContinuey")):void(myTimeout=delay(speed,"runContinuex"))}if(address[pCounter]>=100){if(step1())return button("run","RUN",174,482,"run()"),button("step","STEP",235,482,"step3()"),remove("gt"),remove("speed"),void(running=!1);myTimeout=delay(speed,waitingForInput?"runContinuez":"runContinue")}else step1(),button("run","RUN",174,482,"run()"),button("step","STEP",235,482,"step3()"),remove("gt"),remove("speed"),running=!1}function stop(){stopping=!0,step2Busy&&(s2T?(s2T=0,text("speed","Press STOP again to complete instruction",60,529,12,"red")):doSpeed())}function stop2(){myTimeout&&clearTimeout(myTimeout),myTimeout=!1,myTimeout1&&clearTimeout(myTimeout1),myTimeout1=!1,myTimeout2&&clearTimeout(myTimeout2),myTimeout2=!1,running=!1,step2Busy=!1,waitingForInput=!1}function reset1(){if(stop2(),button("run","RUN",174,482,"run()"),button("step","STEP",235,482,"step3()"),remove("gt"),remove("speed"),remove("au"),remove("red1"),remove("red2"),remove("blue1"),remove("blue2"),updatePC(0),updatePCmarker(0),updateACC(0),output1="",output2="",text("output1","",307,27,12,"black"),text("output2","",341,27,12,"black"),outputCount=0,outputCount2=0,text("ir","",320,248,20,"black"),text("ar","",376,280,20,"black"),savOpenAddress){var e=parseInt(savOpenAddress.id[1]);3==savOpenAddress.id.length&&(e=10*e+parseInt(savOpenAddress.id[2])),setAddress(e,address[e]),savOpenAddress=!1}modifyingProgram&&(modifyingProgram=!1,textToHtml()),text("input","",309,488,16,"black"),message("System reset, edit and ASSEMBLE, RUN/STEP or alter memory")}function step1(){if(waitingForInput)return 0;if(text("ir",inst=Math.floor(address[pCounter]/100),320,248,20,"black"),9==inst||4==inst||address[pCounter]<0)if(901==address[pCounter])inst=9;else if(902==address[pCounter])inst=10;else{if(922!=address[pCounter])return message("Bad instruction at PC = "+pCounter),1;inst=11}switch(text("ar",(addr=address[pCounter]%100)>=10?addr:"0"+addr,376,280,20,"black"),(0==inst||inst>8)&&(addr=""),message(instructionTxt[inst]+addr),updatePC(pCounter+1),updatePCmarker(pCounter),inst){case 1:updateACC(parseInt(accumulator)+parseInt(address[addr]));break;case 2:updateACC(accumulator-address[addr]);break;case 3:setAddress(addr,accumulator);break;case 5:updateACC(address[addr]);break;case 6:updatePC(addr),updatePCmarker(addr);break;case 7:0==accumulator&&(updatePC(addr),updatePCmarker(addr));break;case 8:accumulator>=0&&(updatePC(addr),updatePCmarker(addr));break;case 9:message("INPUT required"),text("input",inputForm,309,488,12,"black"),document.getElementById("iForm").focus(),waitingForInput=!0,inst=0;break;case 10:outputAcc();break;case 11:outputChar();break}return 0}function outputAcc(){outputCount%8==7&&outputCount>8&&(output1=output2,output2="",text("output1",output1,307,27,12,"black","","",monospace)),outputCount<7?(output1?output1+="<br />":outputCount=-1,text("output1",output1+=accumulator,307,27,12,"black","","",monospace)):(output2&&(output2+="<br />"),text("output2",output2+=accumulator,341,27,12,"black","","",monospace)),++outputCount,outputCount2=1,accumulator<0&&++outputCount2,(accumulator<-9||accumulator>9)&&++outputCount2,(accumulator<-99||accumulator>99)&&++outputCount2}function outputChar(){(10==accumulator||outputCount2>=4)&&(outputCount%8==7&&outputCount>8&&(output1=output2,output2="",text("output1",output1,307,27,12,"black","","",monospace)),outputCount<7?(output1&&(output1+="<br />"),text("output1",output1,307,27,12,"black","","",monospace)):(output2&&(output2+="<br />"),text("output2",output2,341,27,12,"black","","",monospace)),++outputCount,outputCount2=0,10==accumulator)||(outputCount<8?text("output1",output1+=32==accumulator?"&nbsp;":String.fromCharCode(accumulator),307,27,12,"black","","",monospace):text("output2",output2+=32==accumulator?"&nbsp;":String.fromCharCode(accumulator),341,27,12,"black","","",monospace),++outputCount2)}var step2Busy=!1;function step2(){waitingForInput||step2Busy||(step2Busy=!0,message("FETCH CYCLE - get current instruction and add 1 to PC"),image("red1","red.gif",redX=310,redY=206,"PC"),text("red2",pCounter,redX+3,redY+3,14,"black"),myTimeout1=delay(valW,"step2a"))}function step2a(){if(redY<307)redY+=s2T;else if(redY<310)310==++redY&&(blueVal=pCounter,image("blue1","red.gif",blueX=(redX+=5)+10,blueY=redY,"PC"),text("blue2",blueVal,blueX+3,blueY+3,14,"black"),inst=0,myTimeout2=delay(valW,"step2e"));else{if(!(redY<408))return move("red1",redX,redY),button("au","+1",327,417,""),text("red2","+1",redX+3,redY+3,14,"black"),void(myTimeout1=delay(300/s2T,"step2b"));redY+=s2T}move("red1",redX,redY),move("red2",redX+3,redY+3),myTimeout1=delay(valW,"step2a")}function step2b(){image("red1","blue1.gif",redX,redY,"PC"),text("red2",pCounter+1,redX+3,redY+3,14,"black"),myTimeout1=delay(valW,"step2c")}function step2c(){if(redX<340)(redX+=s2T)>=340&&remove("au");else{if(!(redY>206))return void step2d();redY-=s2T}move("red1",redX,redY),move("red2",redX+3,redY+3),myTimeout1=delay(valW,"step2c")}function step2d(){redX>309?(move("red1",redX-=s2T,redY),move("red2",redX+3,redY+3),myTimeout1=delay(valW,"step2d")):(myTimeout1=!1,updatePC(pCounter+1),remove("red1"),remove("red2"))}function step2e(){if(blueX<405)blueX+=s2T;else if(blueY<440)blueY+=s2T;else{if(!(blueX<434))return void step2f();blueX+=s2T}move("blue1",blueX,blueY),move("blue2",blueX+3,blueY+3),myTimeout2=delay(valW,"step2e")}function step2f(){if(blueY>60+42*Math.floor(blueVal/10))blueY-=s2T;else{if(!(blueX<476+blueVal%10*37))return image("blue1","blue.gif",blueX,blueY,"PC"),text("blue2",address[blueVal],blueX+3,blueY+3,14,"black"),void(myTimeout2=delay(2*valW,"step2g"));blueX+=s2T}move("blue1",blueX,blueY),move("blue2",blueX+3,blueY+3),myTimeout2=delay(valW,"step2f")}function step2g(){if(blueX>434)blueX-=s2T;else if(blueY<440)blueY+=s2T;else{if(!(blueX>406))return inst?void step2j():(updatePCmarker(pCounter),void step2h());blueX-=s2T}move("blue1",blueX,blueY),move("blue2",blueX+3,blueY+3),myTimeout2=delay(valW,"step2g")}function step2h(){if(blueY>278)blueY-=s2T;else if(blueX>368)blueX-=s2T;else if(blueX>365)365==--blueX&&(text("ar",(addr=address[blueVal]%100)>=10?addr:"0"+addr,376,280,20,"black"),message("FETCH done, decoding instruction"));else if(blueX>315)blueX-=s2T;else{if(!(blueY>250))return text("ir",inst=Math.floor(address[blueVal]/100),320,248,20,"black"),remove("blue1"),remove("blue2"),void(myTimeout2=delay(600/s2T,"step2i"));blueY-=s2T}move("blue1",blueX,blueY),move("blue2",blueX+3,blueY+3),myTimeout2=delay(valW,"step2h")}function step2i(){if(0!=s2T){if(9==inst||address[blueVal]<0)if(901==address[blueVal])inst=9;else if(902==address[blueVal])inst=10;else{if(922!=address[blueVal])return alert("Bad instruction at address = "+blueVal),void(myTimeout2=!1);inst=11}switch((0==inst||4==inst||inst>8)&&(addr=""),message(instructionTxt[inst]+addr),inst){case 1:case 2:case 5:blueVal=addr,image("blue1","red.gif",blueX=376,blueY=280,"AR"),text("blue2",blueVal,blueX+3,blueY+3,14,"black"),myTimeout2=delay(valW,"step2e");break;case 3:image("red1","red.gif",redX=376,redY=280,"AR"),text("red2",addr,redX+3,redY+3,14,"black"),image("blue1","blue.gif",blueX=345,blueY=338,"ACC"),text("blue2",accumulator,blueX+3,blueY+3,14,"black"),myTimeout2=delay(valW,"step2n");break;case 6:step2p();break;case 7:0==accumulator?step2p():(myTimeout2=!1,step2Busy=!1);break;case 8:accumulator>=0?step2p():(myTimeout2=!1,step2Busy=!1);break;case 9:message("INPUT required"),text("input",inputForm,309,488,12,"black"),document.getElementById("iForm").focus(),waitingForInput=!0;break;case 10:case 11:image("blue1","blue.gif",blueX=345,blueY=338,"ACC"),text("blue2",accumulator,blueX+3,blueY+3,14,"black"),myTimeout2=delay(valW,"step2t");break;default:myTimeout2=!1,step2Busy=!1}}else myTimeout2=delay(600/s2T,"step2i")}function step2j(){if(blueY>340)blueY-=s2T;else{if(5!=inst)return image("red1","blue.gif",redX=350,redY=340,"ACC"),text("red2",accumulator,redX+3,redY+3,14,"black"),void step2k();if(!(blueX>345))return remove("blue1"),remove("blue2"),myTimeout2=!1,step2Busy=!1,void updateACC(address[blueVal]);blueX-=s2T}move("blue1",blueX,blueY),move("blue2",blueX+3,blueY+3),myTimeout2=delay(valW,"step2j")}function step2k(){if(blueX>340?blueX-=s2T:blueY<400&&(blueY+=s2T),redX>315?redX-=s2T:redY<400&&(redY+=s2T),redY>=400&&blueY>=400)return 1==inst?(button("au","+",327,417,""),blueVal=parseInt(accumulator)+parseInt(address[blueVal])):(button("au","-",327,417,""),blueVal=accumulator-address[blueVal]),void(myTimeout2=delay(600/s2T,"step2l"));move("blue1",blueX,blueY),move("blue2",blueX+3,blueY+3),move("red1",redX,redY),move("red2",redX+3,redY+3),myTimeout2=delay(valW,"step2k")}function step2l(){0!=s2T?(remove("au"),remove("red1"),remove("red2"),text("blue2",blueVal,blueX+3,blueY+3,14,"black"),myTimeout2=delay(2*valW,"step2m")):myTimeout2=delay(600/s2T,"step2l")}function step2m(){if(blueY>336)return move("blue1",blueX,blueY-=s2T),move("blue2",blueX+3,blueY+3),void(myTimeout2=delay(2*valW,"step2m"));remove("blue1"),remove("blue2"),myTimeout2=!1,step2Busy=!1,updateACC(blueVal)}function step2n(){if(redX<405)redX+=s2T;else if(redY<440)redY+=s2T;else{if(!(redX<434))return void step2o();redX+=s2T}redY>311&&(blueX<405?blueX+=s2T:blueY<440?blueY+=s2T:blueX<434&&(blueX+=s2T)),move("red1",redX,redY),move("red2",redX+3,redY+3),move("blue1",blueX,blueY),move("blue2",blueX+3,blueY+3),myTimeout2=delay(valW,"step2n")}function step2o(){if(redY>60+42*Math.floor(addr/10)?redY-=s2T:redX<476+addr%10*37&&(redX+=s2T),blueX<434)blueX+=s2T;else if(blueY>60+42*Math.floor(addr/10))blueY-=s2T;else{if(!(blueX<476+addr%10*37))return setAddress(addr,accumulator),remove("red1"),remove("red2"),remove("blue1"),remove("blue2"),myTimeout2=!1,void(step2Busy=!1);blueX+=s2T}move("red1",redX,redY),move("red2",redX+3,redY+3),move("blue1",blueX,blueY),move("blue2",blueX+3,blueY+3),myTimeout2=delay(valW,"step2o")}function step2p(){image("red1","red.gif",redX=376,redY=280,"AR"),text("red2",addr,redX+3,redY+3,14,"black"),myTimeout2=delay(valW,"step2q")}function step2q(){if(redY>210)redY-=s2T;else{if(!(redX>310))return updatePC(addr),updatePCmarker(pCounter),remove("red1"),remove("red2"),myTimeout2=!1,void(step2Busy=!1);redX-=s2T}move("red1",redX,redY),move("red2",redX+3,redY+3),myTimeout2=delay(valW,"step2q")}function step2r(){if(blueX<380)blueX+=s2T;else{if(!(blueY>338))return void step2s();blueY-=s2T}move("blue1",blueX,blueY),move("blue2",blueX+3,blueY+3),myTimeout2=delay(valW,"step2r")}function step2s(){if(blueX>345)return move("blue1",blueX-=s2T,blueY),move("blue2",blueX+3,blueY+3),void(myTimeout2=delay(valW,"step2s"));remove("blue1"),remove("blue2"),myTimeout2=!1,step2Busy=!1,updateACC(blueVal)}function step2t(){if(blueX<398&&blueY>65)blueX+=s2T;else if(blueY>65)blueY-=s2T;else{if(!(blueX>360))return remove("blue1"),remove("blue2"),10==inst?outputAcc():outputChar(),myTimeout2=!1,void(step2Busy=!1);blueX-=s2T}move("blue1",blueX,blueY),move("blue2",blueX+3,blueY+3),myTimeout2=delay(valW,"step2t")}function inputSubmit(){var e=document.getElementById("iForm");if(e)if(waitingForInput)if(isNaN(e.value)||""==e.value)alert("Bad input - must be a number");else{var t=parseInt(e.value);t>999||t<-999?alert("Bad input - number out of range"):(text("input",t,309,488,18,"black"),message("INPUT value loaded into accumulator"),inst?(blueVal=t,image("blue1","blue.gif",blueX=309,blueY=488,"INPUT"),text("blue2",blueVal,blueX+3,blueY+3,14,"black"),myTimeout2=delay(valW,"step2r")):updateACC(t),waitingForInput=!1)}else alert("Bad input - not waiting for input");else alert("Bad inputSubmit call")}